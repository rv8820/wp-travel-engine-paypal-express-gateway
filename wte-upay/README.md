# WP Travel Engine - UPay Gateway

Accept payments through Union Bank Philippines' UPay payment gateway for WP Travel Engine bookings.

## Description

This plugin extends WP Travel Engine to accept payments via Union Bank's UPay payment system, which supports multiple payment channels:

- InstaPay
- UnionBank Online
- PESONet
- Over-the-counter payments
- GCash, PayMaya, and other e-wallets

## Requirements

- WordPress 5.0 or higher
- WP Travel Engine 5.0 or higher
- PHP 7.4 or higher
- Union Bank UPay merchant account
- SSL certificate (required for production)

## Installation

1. Upload the plugin files to `/wp-content/plugins/wte-upay/`
2. Activate the plugin through the 'Plugins' menu in WordPress
3. Go to WP Travel Engine → Settings → Payment
4. Enable UPay Payment Gateway
5. Enter your UPay credentials (see Configuration below)

## Configuration

### Getting UPay Credentials

1. Create an account at Union Bank Developer Portal:
   - UAT: https://developer-uat.unionbankph.com
   - Production: https://developer.unionbankph.com

2. Register your application
3. Subscribe to "UPay by UnionBank (1.0.0)" API Product
4. Get your credentials:
   - Client ID (X-IBM-Client-Id)
   - Client Secret (X-IBM-Client-Secret)
   - Partner ID (X-Partner-Id)
   - Biller UUID

### Plugin Settings

Navigate to **WP Travel Engine → Settings → UPay Settings** and enter:

1. **Client ID**: Your X-IBM-Client-Id from Developer Portal
2. **Client Secret**: Your X-IBM-Client-Secret from Developer Portal
3. **Partner ID**: The Partner ID generated by UnionBank
4. **Biller UUID**: Your Biller UUID from UPay

### Test Mode

To enable test/sandbox mode, add this to your `wp-config.php`:

```php
define( 'WP_TRAVEL_ENGINE_PAYMENT_DEBUG', true );
```

This will use the UAT environment for testing.

## API Endpoints

### UAT (Test)
```
https://apiuat.unionbankph.com/ubp/external/upay/payments/v1
```

### Production
```
https://api.unionbankph.com/ubp/external/upay/payments/v1
```

## Features

- **Multiple Payment Channels**: Support for InstaPay, UB Online, PESONet, and more
- **QR Code Payment**: For InstaPay transactions
- **Real-time Status Updates**: Automatic payment verification
- **Secure**: Uses Union Bank's secure API with authentication
- **Admin Dashboard**: View payment details in booking admin
- **Email Notifications**: Automatic confirmation emails
- **WTE 6.0+ Compatible**: Works with latest WP Travel Engine

## Payment Flow

1. Customer selects UPay as payment method during checkout
2. Plugin creates a payment request via UPay API
3. For InstaPay: QR code is displayed for customer to scan
4. For other methods: Customer is redirected to payment page
5. Customer completes payment
6. UPay sends callback to your site
7. Plugin verifies payment and updates booking status
8. Confirmation email is sent to customer

## Troubleshooting

### Enable Debug Mode

Add to `wp-config.php`:

```php
define( 'WP_TRAVEL_ENGINE_PAYMENT_DEBUG', true );
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_LOG', true );
```

Check `/wp-content/debug.log` for API requests and responses.

### Common Issues

**1. Payment not processing**
- Verify all credentials are correct
- Check if Biller UUID is valid
- Ensure SSL certificate is installed (production)
- Check if Partner ID is active

**2. Callback not working**
- Verify your site is accessible from Union Bank servers
- Check if callback URL is correct
- Ensure no security plugins are blocking the callback

**3. API errors**
- Check error messages in debug log
- Verify API credentials are for correct environment (UAT vs Production)
- Ensure required headers are being sent

## API Response Codes

| Code | Status | Description |
|------|--------|-------------|
| 200 | Success | Transaction successful |
| 400 | Bad Request | Missing or invalid parameters |
| 401 | Unauthorized | Invalid credentials |
| 403 | Forbidden | Access token has incorrect scope |
| 404 | Not Found | Resource doesn't exist |
| 500 | Server Error | Internal server error |

## Security

- All API credentials are stored securely in WordPress database
- Sensitive data (Client Secret) is stored as password field
- SSL/TLS encryption for all API communications
- Callback verification for payment status updates

## Support

For issues related to:

- **Plugin**: Create an issue on GitHub or contact support
- **UPay API**: Contact Union Bank Developer Support
- **WP Travel Engine**: Visit WP Travel Engine documentation

## Developer Notes

### Hooks & Filters

**Actions:**
```php
// Before payment processing
do_action( 'wte_payment_gateway_upay_enable', $payment_id, $payment_type, $gateway );

// After payment complete
do_action( 'wptravelengine_process_payment_complete', 'upay_payment', $booking, $payment );
```

**Filters:**
```php
// Modify payment data before sending to API
apply_filters( 'wte_upay_payment_data', $payment_data, $payment_id );

// Customize callback URL
apply_filters( 'wte_upay_callback_url', $callback_url, $payment_id );
```

### Custom Payment Methods

To add custom payment method selection:

```php
add_filter( 'wte_upay_payment_data', function( $data, $payment_id ) {
    // Change from 'instapay' to 'UB Online'
    $data['payment_method'] = 'UB Online';
    return $data;
}, 10, 2 );
```

## Changelog

### 1.0.0
- Initial release
- Support for InstaPay and UB Online
- QR code payment support
- Status verification
- WTE 6.0+ compatibility

## License

GPL-2.0+

## Credits

Developed for WP Travel Engine
Union Bank Philippines UPay API Integration
